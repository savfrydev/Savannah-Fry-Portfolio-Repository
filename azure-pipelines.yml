trigger:
  branches:
    include:
      - main

# If you still have “No hosted parallelism…” use your self-hosted pool here:
pool:
  vmImage: 'ubuntu-latest'

variables:
  AZURE_SERVICE_CONNECTION: 'sc-azure-portfolio'  # <-- your service connection name
  TF_WORKING_DIR: 'infra'
  WEBSITE_DIR: 'website'

stages:
  - stage: terraform
    displayName: "Terraform Deploy"
    jobs:
      - job: terraform
        displayName: "Run Terraform"
        steps:
          - checkout: self

          # Install Terraform
          - task: Bash@3
            displayName: "Install Terraform"
            inputs:
              targetType: inline
              script: |
                set -e
                sudo apt-get update -y
                sudo apt-get install -y gnupg software-properties-common curl unzip
                curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
                echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
                sudo apt-get update -y
                sudo apt-get install -y terraform
                terraform -version

          # Validate early to catch TF errors fast
          - task: AzureCLI@2
            displayName: "Terraform validate"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(TF_WORKING_DIR)
              inlineScript: |
                set -e
                terraform init -upgrade -input=false
                terraform validate

          # Plan & Apply
          - task: AzureCLI@2
            displayName: "Terraform plan/apply"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(TF_WORKING_DIR)
              inlineScript: |
                set -e
                terraform plan -out=tfplan -input=false
                terraform apply -auto-approve tfplan

          # Upload using storage ACCOUNT KEY (no RBAC needed)
          - task: AzureCLI@2
            displayName: "Upload static website files (account key)"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                SA_NAME=$(terraform -chdir=$(TF_WORKING_DIR) output -raw storage_account_name)
                RG_NAME=$(terraform -chdir=$(TF_WORKING_DIR) output -raw resource_group_name)

                echo "Resolving key for storage account: $SA_NAME (RG: $RG_NAME)"
                KEY=$(az storage account keys list -n "$SA_NAME" -g "$RG_NAME" --query "[0].value" -o tsv)

                az storage blob upload-batch \
                  --account-name "$SA_NAME" \
                  --account-key "$KEY" \
                  --destination '$web' \
                  --source $(WEBSITE_DIR)
