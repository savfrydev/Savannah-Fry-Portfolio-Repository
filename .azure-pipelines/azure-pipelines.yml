trigger:
  branches:
    include: [ main ]

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: self

- task: AzureCLI@2
  displayName: "Upload static website files (account key)"
  inputs:
    azureSubscription: $(AZURE_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail

      # Resolve from Terraform
      SA_NAME=$(terraform -chdir="$(TF_WORKING_DIR)" output -raw storage_account_name)
      RG_NAME=$(terraform -chdir="$(TF_WORKING_DIR)" output -raw resource_group_name)

      echo "Storage account: $SA_NAME (RG: $RG_NAME)"
      if [ -z "$SA_NAME" ] || [ -z "$RG_NAME" ]; then
        echo "ERROR: TF outputs missing"; exit 2
      fi

      # Need 'Storage Account Key Operator Service Role' (or Contributor) for this:
      set +x
      KEY=$(az storage account keys list -n "$SA_NAME" -g "$RG_NAME" --query "[0].value" -o tsv)
      set -x
      if [ -z "$KEY" ]; then echo "ERROR: could not retrieve key"; exit 3; fi

      # Enable static site
      az storage blob service-properties update \
        --account-name "$SA_NAME" \
        --static-website \
        --index-document index.html \
        --404-document 404.html \
        --account-key "$KEY" \
        --only-show-errors

      # Upload
      SRC="$(Build.SourcesDirectory)/$(WEBSITE_DIR)"
      echo "Uploading from: $SRC"
      if [ ! -d "$SRC" ]; then echo "ERROR: Source not found: $SRC"; exit 4; fi

      az storage blob upload-batch \
        --account-name "$SA_NAME" \
        --account-key "$KEY" \
        --destination '$web' \
        --source "$SRC" \
        --overwrite \
        --only-show-errors

      echo "Upload complete"
