trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

steps:
# 1. Checkout repository
- checkout: self

# 2. Validate storage account
- task: AzureCLI@2
  displayName: 'Validate storage account'
  inputs:
    azureSubscription: 'sc-azure-portfolio'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail
      echo "Current subscription:"
      az account show --query "{name:name, id:id}" -o tsv
      echo "Checking storage account: $(STORAGE_ACCOUNT_NAME)"
      az storage account show \
        --name "$(STORAGE_ACCOUNT_NAME)" \
        --query "{name:name, resourceGroup:resourceGroup, kind:kind, publicNetworkAccess:publicNetworkAccess}" \
        -o table

# 3. Enable static website and upload content
- task: AzureCLI@2
  displayName: 'Upload static website to $web (RBAC, no keys)'
  inputs:
    azureSubscription: 'sc-azure-portfolio'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail
      SRC="$(Build.SourcesDirectory)/$(SITE_FOLDER)"
      echo "Using source path: $SRC"
      if [ ! -d "$SRC" ]; then
        echo "ERROR: Source not found: $SRC"
        echo "Tip: set SITE_FOLDER='.' if files are at repo root."
        exit 2
      fi

      echo "Enabling static website (idempotent)..."
      az storage blob service-properties update \
        --account-name "$(STORAGE_ACCOUNT_NAME)" \
        --static-website \
        --index-document index.html \
        --404-document 404.html \
        --auth-mode login \
        --only-show-errors || true

      echo "Uploading from $SRC â†’ \$web..."
      az storage blob upload-batch \
        --account-name "$(STORAGE_ACCOUNT_NAME)" \
        --destination '$web' \
        --source "$SRC" \
        --overwrite \
        --auth-mode login \
        --only-show-errors

      echo "Upload complete!"