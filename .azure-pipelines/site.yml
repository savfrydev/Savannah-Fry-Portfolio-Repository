trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # set these in the pipeline UI or variable group (non-secret is fine)
  SITE_FOLDER: '.'
  STORAGE_ACCOUNT_NAME: 'yourstorageacct'

steps:
- checkout: self

# AzureCLI@2 automatically logs in with the service connection you specify.
- task: AzureCLI@2
  displayName: 'Upload static website to $web (RBAC, no keys)'
  inputs:
    azureSubscription: 'sc-azure-portfolio'   # your service connection
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail

      SRC="$(Build.SourcesDirectory)/$(SITE_FOLDER)"
      echo "Using source path: $SRC"
      if [ ! -d "$SRC" ]; then
        echo "ERROR: Source not found: $SRC"
        echo "Tip: set SITE_FOLDER='.' if files are at repo root."
        exit 2
      fi

      echo "Ensuring static website is enabled (idempotent)..."
      az storage blob service-properties update \
        --account-name "$(STORAGE_ACCOUNT_NAME)" \
        --static-website \
        --index-document index.html \
        --404-document 404.html \
        --auth-mode login \
        --only-show-errors || true

      echo "Uploading from $SRC â†’ \$web..."
      az storage blob upload-batch \
        --account-name "$(STORAGE_ACCOUNT_NAME)" \
        --destination '$web' \
        --source "$SRC" \
        --overwrite \
        --auth-mode login \
        --only-show-errors
