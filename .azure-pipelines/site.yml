trigger:
  branches:
    include: [ main ]

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: self

- task: AzureCLI@2
  displayName: "Sanity: show subscription and storage account"
  inputs:
    azureSubscription: $(AZURE_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail
      az account show --query "{name:name,id:id,tenant:tenantId,user:user}" -o table
      echo "STORAGE_ACCOUNT_NAME=$(STORAGE_ACCOUNT_NAME)"
      az storage account show -n "$(STORAGE_ACCOUNT_NAME)" --query "{name:name,kind:kind,isHnsEnabled:isHnsEnabled,publicNetworkAccess:publicNetworkAccess}" -o table

# enable static website + upload using RBAC (no keys)
- task: AzureCLI@2
  displayName: "Upload static website to $web (RBAC, no keys)"
  inputs:
    azureSubscription: $(AZURE_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail
      SRC="$(Build.SourcesDirectory)/$(SITE_FOLDER)"
      test -d "$SRC" || { echo "ERROR: Source not found: $SRC"; exit 2; }

      echo "Enabling static website (idempotent)..."
      az storage blob service-properties update \
        --account-name "$(STORAGE_ACCOUNT_NAME)" \
        --static-website \
        --index-document index.html \
        --404-document 404.html \
        --auth-mode login \
        --only-show-errors || true

      echo "Uploading from $SRC -> \$web ..."
      az storage blob upload-batch \
        --account-name "$(STORAGE_ACCOUNT_NAME)" \
        --destination '$web' \
        --source "$SRC" \
        --overwrite \
        --auth-mode login \
        --only-show-errors

      echo "Upload complete"
